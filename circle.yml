general:
  branches:
    only:
      - master

machine:
  timezone:
    Asia/Tokyo
  services:
    - docker

dependencies:
  pre:
    - docker pull miyukki/docker-texlive
    - docker pull miyukki/redpen:1.7.6
    - git config --global user.email 'miyukki@sfc.wide.ad.jp'
    - git config --global user.name 'Yusei Yamanaka'

test:
  override:
    - exec docker run -i --net=none -v $(pwd):/data miyukki/docker-texlive /bin/sh -c "make"
  post:
    - exec docker run -i --net=none -v $(pwd):/data miyukki/redpen:1.7.6 find . -name "*.tex" -exec /bin/sh -c 'redpen {} > {}.out' \;

deployment:
  release:
    branch: master
    commands:
      - mv main.pdf /tmp/main.pdf
      - |
        if git ls-remote origin | grep -q refs/heads/release; then
          git fetch
          git checkout -b release origin/release
        else
          git checkout --orphan release
          git rm --cached -r .
        fi
      - cp -f /tmp/main.pdf main.pdf
      - git add -f main.pdf
      - git commit -m "[ci skip] Build pdf $CIRCLE_SHA1"
      - git push -f origin release
